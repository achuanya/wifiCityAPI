# WiFi城市API系统架构文档

## 1. 系统概述

WiFi城市API是一个为商家和用户提供WiFi连接与管理服务的平台。本系统主要由后端API服务、数据库和微信小程序组成，旨在实现以下功能：

- 门店WiFi连接管理
- 用户认证与授权
- 扫码连接WiFi记录
- 优惠券管理与核销
- 数据统计与分析

系统使用Go语言开发，采用Gin框架构建RESTful API服务，使用MySQL数据库存储数据。

## 2. 系统架构

### 2.1 总体架构

```
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|  微信小程序前端  | <-> |  WiFi城市API服务  | <-> |  MySQL数据库     |
|                  |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
```

### 2.2 技术栈

- **后端**：Go语言 + Gin框架
- **数据库**：MySQL
- **前端**：微信小程序
- **API类型**：RESTful
- **数据格式**：JSON
- **认证方式**：微信授权 + Token认证

### 2.3 模块结构

```
wifiCityAPI/
├── app/                # 应用主体
│   ├── cmd/            # 命令行入口
│   ├── config/         # 配置文件
│   ├── internal/       # 内部包
│   ├── pkg/            # 公共包
│   └── examples/       # 示例代码
├── binding/            # 数据绑定相关
├── db/                 # 数据库相关
│   └── wifi_city.sql   # 数据库初始化脚本
├── docs/               # 文档
├── ginS/               # Gin框架服务
├── internal/           # 内部功能实现
│   ├── bytesconv/      # 字节转换
│   ├── fs/             # 文件系统
│   └── json/           # JSON处理
├── render/             # 响应渲染
└── testdata/          # 测试数据
```

## 3. 核心功能模块

### 3.1 门店管理模块

**功能说明**：
- 门店信息的增删改查
- 门店地理位置管理
- 门店状态管理
- 查询指定区域内门店
- 查询附近门店

**数据模型**：
- 门店ID
- 门店名称
- 地理位置（国家、省份、城市、区/县、详细地址）
- 坐标（经纬度）
- 联系电话
- WiFi数量
- 门店状态

### 3.2 WiFi配置管理模块

**功能说明**：
- WiFi配置的增删改查
- 批量配置WiFi
- 查询门店所有WiFi配置
- 按类型查询WiFi配置

**数据模型**：
- WiFi ID
- 门店ID
- SSID（WiFi名称）
- 加密密码
- 加密类型（WPA2、WPA3、WEP等）
- WiFi类型（顾客WiFi、员工WiFi、活动WiFi等）
- 最大连接数限制

### 3.3 用户管理模块

**功能说明**：
- 用户信息查询
- 用户信息更新
- 手机号绑定/解绑
- 查询用户扫码历史

**数据模型**：
- 微信UnionID
- 微信OpenID
- 微信昵称
- 微信头像URL
- 手机号
- 性别
- 语言
- 地理位置（国家、省份、城市）

### 3.4 扫码日志模块

**功能说明**：
- 记录用户扫码连接日志
- 查询扫码日志
- 统计扫码量
- 查询连接失败日志
- 更新连接结果

**数据模型**：
- 日志ID
- 门店ID
- 用户UnionID
- 扫码时间
- 设备信息
- IP地址
- 网络类型
- 扫码位置
- 小程序版本
- 连接结果
- 失败原因
- WiFi信息（SSID、MAC地址、信号强度）
- 二维码类型和ID

### 3.5 优惠券管理模块

**功能说明**：
- 优惠券的增删改查
- 批量创建优惠券
- 查询可用优惠券
- 更新优惠券状态和限制

**数据模型**：
- 优惠券ID
- 优惠券名称
- 优惠券兑换码
- 优惠券类型（折扣券、现金券、礼品券、运费券）
- 优惠券面值
- 使用限制（最低消费金额）
- 发行量控制
- 有效期控制
- 适用门店
- 优惠券状态

### 3.6 优惠券日志模块

**功能说明**：
- 记录优惠券领取、使用、过期、退回
- 查询优惠券领取和使用情况
- 查询门店优惠券核销记录

**数据模型**：
- 日志ID
- 优惠券ID
- 用户UnionID
- 门店ID
- 行为类型（发放、领取、使用、过期、退券）
- 行为时间
- 关联订单
- 抵扣金额
- 状态

### 3.7 数据统计与报表模块

**功能说明**：
- 门店统计（总数、分布、增长趋势）
- WiFi使用统计（连接次数、成功率、失败原因）
- 用户行为统计（新用户、活跃用户、地域分布）
- 优惠券统计（发行量、领取量、使用率）
- 流量与访问统计（访问量、用户数、活跃用户）

## 4. 数据库设计

系统使用MySQL数据库，主要包含以下表：

### 4.1 门店表 (store)
存储门店基本信息，包括ID、名称、地址、坐标、状态等。

### 4.2 WIFI配置表 (wifi_config)
存储各门店的WiFi配置信息，包括SSID、密码（加密存储）、加密类型等。

### 4.3 用户信息表 (user_profile)
存储用户基本信息，包括微信相关信息、手机号、地理位置等。

### 4.4 扫码日志表 (scan_log)
记录用户扫码连接WiFi的日志，包括时间、位置、设备信息、连接结果等。

### 4.5 优惠券表 (coupon)
存储优惠券基本信息，包括名称、类型、面值、有效期、使用限制等。

### 4.6 优惠券日志表 (coupon_log)
记录优惠券的领取、使用、过期等操作日志。

### 4.7 小程序配置表 (app_config)
存储小程序的配置信息，包括AppID、调用凭证等。

## 5. 接口设计

系统提供RESTful API接口，主要分为以下几类：

- 门店相关API
- WIFI配置相关API
- 用户信息相关API
- 扫码日志相关API
- 优惠券相关API
- 优惠券日志相关API
- 数据统计与报表API

详细接口信息请参阅《API参考文档》。

## 6. 安全机制

### 6.1 认证与授权
- 微信授权登录
- Token认证
- 权限控制

### 6.2 数据安全
- WiFi密码加密存储
- 敏感信息（手机号等）加密
- HTTPS传输
- SQL注入防护
- XSS防护

### 6.3 日志与审计
- 操作日志记录
- 错误日志记录
- 安全审计

## 7. 扩展性考虑

### 7.1 水平扩展
- API服务无状态设计，支持多实例部署
- 数据库分库分表预留
- 缓存层预留

### 7.2 功能扩展
- 插件化设计
- 接口版本控制
- 配置中心

## 8. 部署架构

### 8.1 开发环境
- 单机部署
- 本地数据库

### 8.2 测试环境
- 服务集群（小规模）
- 数据库主从

### 8.3 生产环境
- 服务集群（负载均衡）
- 数据库集群
- CDN加速
- 监控报警系统

## 9. 性能优化

### 9.1 数据库优化
- 索引优化
- 查询优化
- 分区表（扫码日志表按时间分区）

### 9.2 API性能优化
- 接口缓存
- 数据压缩
- 连接池管理

## 10. 监控与维护

### 10.1 系统监控
- 服务健康检查
- 性能指标监控
- 异常监控

### 10.2 报警机制
- 阈值报警
- 异常报警
- 安全事件报警

### 10.3 日常维护
- 数据备份
- 日志清理
- 系统更新 